<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Tim Redaksi - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --navy-dark: #0a192f;
            --navy-light: #172a45;
            --mustard: #ffc107;
            --white: #ffffff;
            --light-bg: #f4f6f9;
            --danger: #dc3545;
            --success: #28a745;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { background-color: var(--light-bg); min-height: 100vh; display: flex; flex-direction: column; }

        /* --- HEADER --- */
        header {
            background-color: var(--navy-dark); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo-wrapper {
            width: 40px; height: 40px; background: var(--white);
            border-radius: 50%; border: 2px solid var(--mustard);
            display: flex; justify-content: center; align-items: center;
        }
        .header-logo { width: 60%; height: auto; }
        .header-title { color: var(--white); font-weight: 700; font-size: 1rem; }
        
        .btn-back {
            color: var(--mustard); text-decoration: none; font-weight: 600;
            font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
            border: 1px solid var(--mustard); padding: 5px 15px; border-radius: 20px;
            transition: 0.3s;
        }
        .btn-back:hover { background: var(--mustard); color: var(--navy-dark); }

        /* --- LAYOUT UTAMA --- */
        main { 
            flex: 1; padding: 30px 20px; max-width: 1100px; margin: 0 auto; width: 100%;
            display: grid; grid-template-columns: 1fr 350px; gap: 30px;
        }

        /* --- LEFT SIDE: FORM & LIST --- */
        .admin-panel {
            background: var(--white); padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .section-title { font-size: 1.2rem; font-weight: 700; color: var(--navy-dark); margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: var(--navy-light); }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; outline: none; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--mustard); }

        .upload-row { display: flex; gap: 15px; align-items: center; }
        .img-preview-box {
            width: 70px; height: 70px; border-radius: 50%; background: #eee;
            border: 2px dashed #ccc; overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }

        .btn-upload {
            padding: 8px 15px; background: #eee; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; font-size: 0.85rem;
        }
        
        .btn-save {
            width: 100%; padding: 12px; background: var(--navy-dark); color: white;
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
            margin-top: 10px; transition: 0.3s;
        }
        .btn-save:hover { background: var(--navy-light); }
        .btn-cancel {
            width: 100%; padding: 12px; background: #ddd; color: #555;
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
            margin-top: 10px; display: none;
        }

        /* List Member */
        .member-list { margin-top: 30px; display: grid; gap: 10px; }
        .member-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee;
        }
        .member-info { display: flex; align-items: center; gap: 15px; }
        .member-thumb { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--mustard); }
        .member-text h4 { font-size: 0.95rem; color: var(--navy-dark); margin: 0; }
        .member-text p { font-size: 0.8rem; color: #666; margin: 0; }

        .action-btns { display: flex; gap: 5px; }
        .btn-mini {
            width: 30px; height: 30px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; color: white;
        }
        .btn-edit { background: var(--mustard); color: var(--navy-dark); }
        .btn-delete { background: var(--danger); }

        /* --- RIGHT SIDE: PHONE MOCKUP (LIVE PREVIEW) --- */
        .preview-container { position: sticky; top: 80px; }
        .preview-title { text-align: center; margin-bottom: 10px; color: #666; font-size: 0.9rem; }
        
        .phone-mockup {
            width: 300px; height: 500px; background: var(--navy-dark);
            border-radius: 30px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 0 auto; position: relative;
        }
        
        .phone-screen {
            width: 100%; height: 100%; background: #f0f2f5; border-radius: 20px;
            overflow: hidden; position: relative; display: flex; flex-direction: column;
        }

        /* Simulasi Header App */
        .app-header {
            background: var(--navy-dark); height: 50px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 0.8rem; font-weight: bold;
        }

        /* Area Carousel */
        .carousel-area {
            flex: 1; display: flex; align-items: center; justify-content: center;
            background: #fff; position: relative; overflow: hidden;
        }

        /* Kartu di dalam Mockup */
        .mock-card {
            background: var(--white); padding: 20px; border-radius: 12px;
            text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 80%; position: absolute;
            opacity: 0; transform: translateX(100px); transition: all 0.5s ease-in-out;
        }
        .mock-card.active { opacity: 1; transform: translateX(0); }
        .mock-card.exit { opacity: 0; transform: translateX(-100px); }

        .mock-img {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            margin-bottom: 10px; border: 3px solid var(--mustard);
        }
        .mock-name { font-weight: 700; color: var(--navy-dark); font-size: 1rem; }
        .mock-role { font-size: 0.8rem; color: #888; }

        /* Loader */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,25,47,0.9); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column; color: var(--mustard);
        }
        
        /* Toast */
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: var(--white); color: var(--navy-dark); padding: 15px;
            border-radius: 8px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-left: 5px solid var(--success); display: none;
        }
        .toast.show { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        @media (max-width: 900px) {
            main { grid-template-columns: 1fr; }
            .preview-container { display: none; }
        }
    </style>
</head>
<body>

    <div id="loader-overlay"><i class="fas fa-circle-notch fa-spin fa-3x"></i><p style="margin-top:15px">Menyimpan Data...</p></div>
    <div id="notification-area"></div>

    <header>
        <div class="header-left">
            <div class="header-logo-wrapper">
                <img src="https://i.imgur.com/5Srjyo4.png" alt="Logo" class="header-logo">
            </div>
            <div class="header-title">TIM REDAKSI</div>
        </div>
        <a href="../index.html" class="btn-back">
            <i class="fas fa-arrow-left"></i> Kembali
        </a>
    </header>

    <main>
        <div class="admin-panel">
            <h2 class="section-title">Kelola Anggota Tim</h2>
            
            <form id="team-form">
                <div class="form-group">
                    <label class="form-label">Foto Profil (Wajib)</label>
                    <div class="upload-row">
                        <div class="img-preview-box">
                            <img id="img-preview" src="https://via.placeholder.com/100?text=Foto" alt="Preview">
                        </div>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                        <button type="button" class="btn-upload" onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-camera"></i> Pilih Foto
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Nama Lengkap</label>
                    <input type="text" id="inp-name" class="form-control" placeholder="Contoh: Kak Saras" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Jabatan / Posisi</label>
                    <input type="text" id="inp-role" class="form-control" placeholder="Contoh: Editor in Chief" required>
                </div>

                <button type="submit" class="btn-save" id="btn-submit">
                    <i class="fas fa-plus-circle"></i> TAMBAHKAN ANGGOTA
                </button>
                <button type="button" class="btn-cancel" id="btn-cancel">
                    BATAL EDIT
                </button>
            </form>

            <div class="member-list" id="member-container">
                <p style="text-align:center; color:#999;">Memuat tim...</p>
            </div>
        </div>

        <div class="preview-container">
            <div class="preview-title">Tampilan di HP Siswa (Bergerak tiap 5 detik)</div>
            <div class="phone-mockup">
                <div class="phone-screen">
                    <div class="app-header">CENDEKIA PRESS</div>
                    <div class="carousel-area" id="mockup-carousel">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSIfZG7T_iKAofXMxqXWa2qf8dzN1gvbQ",
            authDomain: "cendekia-press.firebaseapp.com",
            projectId: "cendekia-press",
            storageBucket: "cendekia-press.firebasestorage.app",
            messagingSenderId: "677985700234",
            appId: "1:677985700234:web:c0d829fdd15c5ab351a073"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let editModeId = null;
        let currentImgUrl = null;
        let teamDataLocal = []; // Untuk carousel

        // 1. CEK ADMIN
        onAuthStateChanged(auth, (user) => {
            if (!user || !user.email.endsWith('@ac.id')) {
                window.location.href = "../../dashboard/index.html";
            } else {
                loadTeams();
            }
        });

        // 2. PREVIEW IMAGE SEBELUM UPLOAD
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('img-preview').src = e.target.result;
                reader.readAsDataURL(this.files[0]);
            }
        });

        // 3. SUBMIT FORM (ADD / EDIT)
        document.getElementById('team-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('inp-name').value;
            const role = document.getElementById('inp-role').value;
            const file = fileInput.files[0];

            if (!editModeId && !file) {
                alert("Wajib upload foto untuk anggota baru!");
                return;
            }

            document.getElementById('loader-overlay').style.display = 'flex';

            try {
                let finalUrl = currentImgUrl;

                // Jika ada file baru, upload ke ImgBB
                if (file) {
                    const formData = new FormData();
                    formData.append("image", file);
                    const res = await fetch("https://api.imgbb.com/1/upload?key=2f45fcafb6dfb2dbae295499022ce476", {
                        method: "POST", body: formData
                    });
                    const data = await res.json();
                    if(data.success) finalUrl = data.data.url;
                    else throw new Error("Gagal upload gambar");
                }

                // Simpan ke Firestore
                if (editModeId) {
                    await updateDoc(doc(db, "teams", editModeId), {
                        name: name, role: role, photoUrl: finalUrl
                    });
                    showToast("Data diperbarui!");
                } else {
                    await addDoc(collection(db, "teams"), {
                        name: name, role: role, photoUrl: finalUrl,
                        createdAt: new Date()
                    });
                    showToast("Anggota ditambahkan!");
                }

                resetForm();

            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                document.getElementById('loader-overlay').style.display = 'none';
            }
        });

        // 4. LOAD DATA (LIST & CAROUSEL)
        function loadTeams() {
            const listContainer = document.getElementById('member-container');
            const carouselContainer = document.getElementById('mockup-carousel');
            
            const q = query(collection(db, "teams"), orderBy("createdAt", "asc")); // Urutkan biar yang lama di awal

            onSnapshot(q, (snapshot) => {
                listContainer.innerHTML = "";
                carouselContainer.innerHTML = "";
                teamDataLocal = [];

                if (snapshot.empty) {
                    listContainer.innerHTML = "<p style='text-align:center; padding:20px;'>Belum ada anggota tim.</p>";
                    return;
                }

                let index = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    teamDataLocal.push(data); // Simpan untuk referensi

                    // A. Render List (Admin View)
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.innerHTML = `
                        <div class="member-info">
                            <img src="${data.photoUrl}" class="member-thumb">
                            <div class="member-text">
                                <h4>${data.name}</h4>
                                <p>${data.role}</p>
                            </div>
                        </div>
                        <div class="action-btns">
                            <button class="btn-mini btn-edit" onclick="editTeam('${doc.id}', '${data.name}', '${data.role}', '${data.photoUrl}')">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="btn-mini btn-delete" onclick="deleteTeam('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(item);

                    // B. Render Mockup Card (Hidden by default, active class added later)
                    const mockCard = document.createElement('div');
                    mockCard.className = index === 0 ? 'mock-card active' : 'mock-card';
                    mockCard.innerHTML = `
                        <img src="${data.photoUrl}" class="mock-img">
                        <div class="mock-name">${data.name}</div>
                        <div class="mock-role">${data.role}</div>
                    `;
                    carouselContainer.appendChild(mockCard);
                    index++;
                });

                startCarouselAnimation();
            });
        }

        // 5. CAROUSEL ANIMATION
        let intervalId;
        function startCarouselAnimation() {
            if (intervalId) clearInterval(intervalId);
            
            const cards = document.querySelectorAll('.mock-card');
            if (cards.length <= 1) return;

            let currentIndex = 0;
            intervalId = setInterval(() => {
                // Animasi Keluar
                cards[currentIndex].classList.remove('active');
                cards[currentIndex].classList.add('exit');

                // Pindah Index
                currentIndex = (currentIndex + 1) % cards.length;

                // Animasi Masuk (Delay dikit biar smooth)
                setTimeout(() => {
                    // Reset kartu sebelumnya agar siap masuk lagi nanti
                    const prevIndex = (currentIndex === 0) ? cards.length - 1 : currentIndex - 1;
                    cards[prevIndex].classList.remove('exit');
                    
                    // Kartu baru masuk
                    cards[currentIndex].classList.add('active');
                }, 500); // 0.5s match CSS transition

            }, 5000); // 5 Detik
        }

        // 6. GLOBAL ACTIONS
        window.editTeam = function(id, name, role, url) {
            editModeId = id;
            currentImgUrl = url;
            document.getElementById('inp-name').value = name;
            document.getElementById('inp-role').value = role;
            document.getElementById('img-preview').src = url;
            
            document.getElementById('btn-submit').innerHTML = '<i class="fas fa-save"></i> SIMPAN PERUBAHAN';
            document.getElementById('btn-cancel').style.display = 'block';
        }

        window.deleteTeam = async function(id) {
            if(confirm("Hapus anggota ini dari tim?")) {
                await deleteDoc(doc(db, "teams", id));
                showToast("Anggota dihapus.");
            }
        }

        const resetForm = () => {
            document.getElementById('team-form').reset();
            editModeId = null;
            currentImgUrl = null;
            document.getElementById('img-preview').src = 'https://via.placeholder.com/100?text=Foto';
            document.getElementById('btn-submit').innerHTML = '<i class="fas fa-plus-circle"></i> TAMBAHKAN ANGGOTA';
            document.getElementById('btn-cancel').style.display = 'none';
        }
        document.getElementById('btn-cancel').addEventListener('click', resetForm);

        function showToast(msg) {
            const area = document.getElementById('notification-area');
            area.innerHTML = `<div class="toast show">${msg}</div>`;
            setTimeout(() => { area.innerHTML = ''; }, 3000);
        }
    </script>
</body>
</html>
